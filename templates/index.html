<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murder on the Flying Scotsman</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Courier+Prime:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <style>
        /* --- SKEUOMORPHIC LUXURY THEME --- */
        :root {
            --velvet-blue: #0a1020;
            --gold: #d4af37;
            --gold-shadow: #8a7020;
            --cream: #f5f5dc;
            --burgundy: #660015;
            --paper: #fffcf5;
            --leather-dark: #1a0f0a;
            --wood: #3e2723;
        }

        * {
            box-sizing: border-box;
        }

        body {
            /* Deep Royal Blue Velvet / Leather Table Texture */
            background-color: var(--velvet-blue);
            background-image:
                radial-gradient(circle at 50% 50%, #162035 0%, #050810 100%),
                url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            color: var(--cream);
            font-family: 'Courier Prime', monospace;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            /* Start from top to allow scrolling if board is long */
            padding: 40px 20px;
            overflow-x: hidden;
        }

        /* The "Board" Container */
        .main-container {
            width: 100%;
            max-width: 1100px;
            /* Wood border effect */
            border: 15px solid var(--wood);
            border-image: linear-gradient(45deg, #3e2723, #5d4037, #3e2723) 1;
            box-shadow:
                0 0 0 2px #1a0f0a inset,
                /* Inner dark edge */
                0 20px 50px rgba(0, 0, 0, 0.8);
            /* Deep table shadow */
            padding: 40px;
            position: relative;
            background: rgba(15, 23, 42, 0.6);
            /* Slightly see-through to velvet */
            backdrop-filter: blur(2px);
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            text-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 20px;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 3.5rem;
            /* Larger Title */
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 5px;
            background: linear-gradient(to bottom, #fff7cc, #d4af37, #8a7020);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.5));
        }

        h2,
        h3 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
        }

        .server-status {
            font-size: 0.9rem;
            color: #888;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* --- LOBBY --- */
        #lobby-screen {
            text-align: center;
            padding: 60px;
            /* Ticket Look */
            background: var(--paper);
            color: var(--leather-dark);
            width: 600px;
            margin: 0 auto;
            transform: rotate(-1deg);
            box-shadow: 5px 10px 20px rgba(0, 0, 0, 0.4);
            border: 2px dashed #000;
        }

        #lobby-screen h2 {
            color: var(--leather-dark);
            letter-spacing: 2px;
        }

        input {
            background: transparent;
            border: none;
            border-bottom: 3px solid var(--leather-dark);
            color: var(--leather-dark);
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 10px;
            text-align: center;
            width: 80%;
            outline: none;
            margin: 30px 0;
        }

        input::placeholder {
            color: rgba(0, 0, 0, 0.3);
        }

        button {
            background: linear-gradient(to bottom, #d4af37, #b4941f);
            border: 1px solid #8a7020;
            color: #2b1d0e;
            padding: 15px 40px;
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 0 4px 0 #8a7020, 0 10px 10px rgba(0, 0, 0, 0.3);
            /* 3D Button */
            transition: all 0.1s ease;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            margin: 10px;
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #8a7020, inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            filter: brightness(1.1);
        }

        /* --- GAME UI --- */
        .hidden {
            display: none !important;
        }

        /* Role Card (Dossier) */
        .identity-card {
            background-color: #fcfbf7;
            /* Off-white paper */
            color: #1a1a1a;
            padding: 30px;
            width: 450px;
            margin: 0 auto 50px;
            /* Physical Paper Properties */
            box-shadow:
                1px 1px 0 #ddd,
                2px 2px 0 #ccc,
                5px 15px 30px rgba(0, 0, 0, 0.5);
            /* Deep shadow lift */
            transform: rotate(-2deg);
            /* Organic placement */
            position: relative;
            z-index: 10;
        }

        /* Paper Texture Overlay */
        .identity-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        /* "CONFIDENTIAL" Stamp - Fixed Opacity/Layering */
        .identity-card::after {
            content: "CONFIDENTIAL";
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 3.5rem;
            color: #8b0000;
            font-family: 'Courier Prime', monospace;
            font-weight: bold;
            border: 4px solid #8b0000;
            padding: 10px 20px;
            opacity: 0.15;
            /* More transparent to read text */
            pointer-events: none;
            mix-blend-mode: multiply;
            /* Blends nicely with paper */
        }

        .identity-card h3 {
            color: #333;
            border-bottom: 2px solid #333;
            margin-top: 0;
            text-transform: uppercase;
            font-size: 1.4rem;
            letter-spacing: 3px;
        }

        #my-role {
            font-size: 1.8rem;
            font-weight: bold;
            font-family: 'Typewriter', 'Courier Prime', monospace;
            color: #000;
            margin: 25px 0;
            position: relative;
            z-index: 5;
            /* Ensure text is above stamp */
        }

        /* Track (Board Game Style) */
        .track-container {
            position: relative;
            margin: 80px 0;
            height: 8px;
            /* Thicker line */
            background: linear-gradient(to bottom, #ffd700, #b8860b);
            /* Gold Bar */
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .station {
            width: 24px;
            height: 24px;
            background: var(--bg-navy);
            border: 4px solid #ffd700;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        /* Active Station Glow */
        .station.active-glow {
            background: #ffd700;
            box-shadow: 0 0 20px #ffd700;
        }

        /* Legibility: Larger, Bold, Gold Labels */
        .station-label {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-20%) rotate(-45deg);
            transform-origin: bottom left;
            font-family: 'Playfair Display', serif;
            color: #ffd700;
            /* Bright Gold */
            font-size: 1.1rem;
            /* Larger */
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #000;
            white-space: nowrap;
        }

        /* Player Tokens (Unicode Trains/Pawns) */
        .player-token {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            position: absolute;
            top: 50px;
            /* Moved below the line */
            transform: translate(-50%, 0);
            /* Reset vertical translation */
            z-index: 10;
            font-size: 2rem;
            filter: drop-shadow(2px 4px 4px rgba(0, 0, 0, 0.6));
            /* Cast shadow on board */
            transition: left 1.0s cubic-bezier(0.5, 0, 0, 1);
        }

        /* Token Label (Name) */
        .player-token .token-name {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            background: #000;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            opacity: 0.8;
        }

        /* Passenger Manifest (Ticket Styled List) */
        .passenger-manifest {
            background: #fdf5e6;
            /* Old Lace */
            border: 1px solid #d2b48c;
            padding: 15px;
            width: fit-content;
            margin: 0 auto;
            position: relative;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.3);
            /* Corner cuts for ticket look */
            clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%,
                    0% 20%, 5% 25%, 0% 30%
                    /* Jagged edge simulation simplified */
                );
        }

        .passenger-manifest h4 {
            margin: 0 0 10px 0;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px dotted #aaa;
            font-size: 0.8rem;
        }

        #player-list {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .manifest-entry {
            font-family: 'Courier Prime', monospace;
            color: #333;
            border: 1px solid #ddd;
            padding: 5px 10px;
            background: #fff;
        }

        /* Log Journal */
        .log-container {
            background: var(--paper);
            color: #2b1d0e;
            background-image:
                linear-gradient(#e8e0c7 1px, transparent 1px);
            background-size: 100% 1.5em;
            /* Lined paper */
            border: 1px solid #c0b090;
            height: 250px;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Courier Prime', monospace;
            line-height: 1.5em;
            margin-top: 50px;
            /* Box shadow for depth */
            box-shadow:
                1px 1px 2px rgba(0, 0, 0, 0.2),
                10px 10px 30px rgba(0, 0, 0, 0.4);
            transform: rotate(1deg);
            /* Slight natural rotation */
            position: relative;
        }

        /* Top tape */
        .log-container::before {
            content: "";
            position: absolute;
            top: -15px;
            left: 40%;
            width: 100px;
            height: 35px;
            background: rgba(255, 255, 255, 0.4);
            border-left: 1px dashed rgba(0, 0, 0, 0.1);
            border-right: 1px dashed rgba(0, 0, 0, 0.1);
            transform: rotate(-2deg);
            z-index: 20;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        #game-log div {
            padding-left: 10px;
        }

        #game-log div::before {
            content: "- ";
            color: #888;
        }

        /* Controls */
        .control-panel {
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        #status-message {
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 25px;
            font-family: 'Playfair Display', serif;
            font-style: italic;
            text-shadow: 1px 1px 0 #000;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 8, 16, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            border: 8px solid var(--gold);
            background: #0f172a;
            color: var(--cream);
            width: 90%;
            max-width: 700px;
            padding: 40px;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
            text-align: center;
        }

        #q-text {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 30px;
            border-bottom: 1px solid var(--gold);
            padding-bottom: 20px;
        }

        .options-grid button {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
        }

        .options-grid button:hover {
            background: var(--gold);
            color: #000;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--leather-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: #5d4037;
            border: 1px solid #3e2723;
        }

        /* --- SPECTATOR MODE (RETRO TV STYLE) --- */
        body.spectator-theme {
            filter: sepia(0.8) contrast(1.2) grayscale(0.2);
        }

        body.spectator-theme::after {
            /* CRT Scanline Overlay */
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .spectator-banner {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            border: 4px double red;
            color: red;
            padding: 10px 20px;
            font-family: 'Courier Prime', monospace;
            font-weight: bold;
            font-size: 1.5rem;
            transform: rotate(5deg);
            z-index: 10000;
            background: rgba(0, 0, 0, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: blink 2s infinite;
        }

        body.spectator-theme .spectator-banner {
            display: block;
        }

        body.spectator-theme .control-panel,
        body.spectator-theme .identity-card,
        body.spectator-theme #lobby-screen {
            pointer-events: none;
            /* Disable interaction */
            opacity: 0.8;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="spectator-banner">CLASSIFIED :: SPECTATOR ONLY</div>

    <div class="main-container">
        <header>
            <h1>Murder on the Flying Scotsman</h1>
            <div class="server-status">::: Secure Connection - 1934 :::</div>
        </header>

        <main>
            <!-- LOBBY -->
            <div id="lobby-screen">
                <h2>BOARDING PASS</h2>
                <div
                    style="font-family: 'Courier Prime'; font-size: 0.8rem; margin-bottom: 20px; border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 5px 0;">
                    LONDON & NORTH EASTERN RAILWAY</div>
                <input type="text" id="player-name" placeholder="Passenger Name" maxlength="15" autocomplete="off">
                <br>
                <div style="color: #666; font-size: 0.7rem; margin-top: 10px;">NON-TRANSFERABLE ‚Ä¢ CLASS I</div>
                <button onclick="joinGame()">Embarquer</button>
            </div>

            <!-- GAME -->
            <div id="game-screen" class="hidden">

                <!-- Role Dossier with Depth -->
                <div class="identity-card">
                    <h3>Confidential Profile</h3>
                    <p id="my-role">Role: ???</p>
                    <p class="small-print" style="margin-top: 15px; font-size: 0.7em; color: #555;">DESTROY AFTER
                        READING</p>
                </div>

                <!-- Gold Track -->
                <div class="track-container">
                    <div id="stations-display"></div>
                </div>

                <!-- Info & Players (Ticket Style) -->
                <div class="info-panel" style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <div class="passenger-manifest">
                        <h4>Passenger Manifest</h4>
                        <div id="player-list">
                            <!-- Player list populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="control-panel">
                    <div id="status-message">Awaiting departure...</div>
                    <div id="actions">
                        <button id="btn-ready" onclick="toggleReady()"
                            style="background-color: #d4af37; color: #000; display:none;">SE PR√âPARER</button>
                        <button id="btn-start" onclick="startGame()" class="hidden">D√âPART D'√âDIMBOURG</button>
                        <button id="btn-roll" onclick="rollDice()" class="hidden">LANCER LES D√âS</button>
                    </div>
                </div>

                <!-- Log Journal with Shadow -->
                <div class="log-container">
                    <!-- Note: CSS pseudo-element creates the scotch tape effect -->
                    <h3 style="color: #4a3b2a; border-bottom: 2px solid #4a3b2a; display: inline-block;">Captain's Log
                    </h3>
                    <div id="game-log"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Top Right Sound Toggle -->
    <div id="sound-toggle" onclick="toggleMute()"
        style="position: fixed; top: 20px; right: 20px; cursor: pointer; font-size: 2rem; z-index: 1000; filter: drop-shadow(0 0 5px #000);">
        üîä
    </div>

    <!-- Hidden Audio Element -->
    <audio id="bgm" loop>
        <source src="{{ url_for('static', filename='bgm.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="victory-music">
        <source src="{{ url_for('static', filename='victory.mp3') }}" type="audio/mpeg">
    </audio>

    <!-- Modals -->
    <div id="question-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="q-text">Inquiry?</h2>
            <div id="q-options" class="options-grid"></div>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content">
            <h1 style="color: var(--gold); font-size: 3rem;">FINALE</h1>
            <h2 id="winner-display" style="font-family: 'Courier Prime'; margin: 20px 0;">Winner: ???</h2>
            <button onclick="location.reload()">New Game</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='game.js') }}?v=3"></script>
    <script>
        // --- Overwrite Render Function for Skeuomorphic Tokens/List ---
        // We inject this here to override game.js without breaking cache or requiring deeper logic changes
        // Using "window.onload" to ensure game.js is loaded first.
        window.onload = function () {
            setTimeout(() => {
                if (typeof originalRenderPlayers !== 'undefined') {
                    // We already hooked it in game.js, but let's redefine the render logic here for visually distinct tokens
                    renderPlayers = function (players) {
                        lastStatePlayers = players;
                        const playerList = document.getElementById('player-list');
                        const stationsDisplay = document.getElementById('stations-display');

                        playerList.innerHTML = '';
                        document.querySelectorAll('.player-token').forEach(el => el.remove());

                        let offsetMap = {}; // To stack players at same station

                        Object.values(players).forEach(p => {
                            // 1. Manifest Entry (Ticket Style)
                            const entry = document.createElement('div');
                            entry.className = 'manifest-entry';

                            const readyStatus = p.is_ready ? "‚úÖ READY" : "‚è≥ WAITING";
                            const roleStatus = p.is_frozen ? "(FROZEN)" : "";

                            entry.innerHTML = `<strong>${p.name}</strong> <span style='font-size:0.8em; color:#666'>${p.station_name}</span><br>
                                               <span style='font-size:0.7em; color:${p.is_ready ? 'green' : 'red'}; font-weight:bold'>${readyStatus} ${roleStatus}</span>`;

                            if (p.is_frozen) entry.style.backgroundColor = "#e0f7fa";
                            playerList.appendChild(entry);

                            // 2. Map Token (Train Piece)
                            const token = document.createElement('div');
                            token.className = 'player-token';
                            // Use Emoji Train or Pawn
                            token.innerText = "‚ôü"; // Classic Pawn
                            token.style.color = stringToColor(p.name);

                            // Calculate stacking offset
                            if (!offsetMap[p.position]) offsetMap[p.position] = 0;
                            const stackOffset = offsetMap[p.position] * 15;
                            offsetMap[p.position]++;

                            const pct = (p.position / (STATIONS.length - 1)) * 100;
                            token.style.left = `calc(${pct}% + ${stackOffset}px)`; // Add offset

                            // Name Tooltip
                            const label = document.createElement('div');
                            label.className = 'token-name';
                            label.innerText = p.name;
                            token.appendChild(label);

                            stationsDisplay.appendChild(token);
                        });
                    }
                }
            }, 500); // Small delay to ensure socket/game.js loaded
        };
    </script>
    <script>
        function toggleMute() {
            const bgm = document.getElementById('bgm');
            const icon = document.getElementById('sound-toggle');
            if (bgm.paused) {
                bgm.play();
                icon.innerText = "üîä";
            } else {
                bgm.pause();
                icon.innerText = "üîá";
            }
        }
    </script>
</body>

</html>